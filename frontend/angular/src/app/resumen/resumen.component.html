<section class="card">
  <h2>Clientes registrados</h2>
  <p class="helper-text">Administrá los datos fiscales desde aquí para reutilizarlos al emitir facturas.</p>

  <div class="card-inline">
    <h3>{{ clienteEditando ? 'Editar cliente' : 'Agregar nuevo cliente' }}</h3>
    <div class="grid two-columns">
      <div>
        <label for="nuevoNombre">Nombre y apellido / Razón social</label>
        <input id="nuevoNombre" [(ngModel)]="nuevoCliente.name" name="nuevoClienteNombre" placeholder="Ej: Juan Pérez" />
      </div>
      <div>
        <label for="nuevoEmail">Email de contacto</label>
        <input id="nuevoEmail" type="email" [(ngModel)]="nuevoCliente.email" name="nuevoClienteEmail" placeholder="Ej: facturacion@cliente.com" />
      </div>
      <div>
        <label for="nuevoCuit">Número de CUIT</label>
        <input id="nuevoCuit" [(ngModel)]="nuevoCliente.tax_id" name="nuevoClienteCuit" placeholder="Ej: 30-12345678-9" />
      </div>
      <div>
        <label for="nuevoDomicilio">Dirección fiscal</label>
        <input id="nuevoDomicilio" [(ngModel)]="nuevoCliente.fiscal_address" name="nuevoClienteDomicilio" placeholder="Ej: Av. Siempre Viva 742" />
      </div>
      <div>
        <label for="nuevoCondicion">Condición fiscal</label>
        <select id="nuevoCondicion" [(ngModel)]="nuevoCliente.tax_condition" name="nuevoClienteCondicion">
          <option *ngFor="let cond of taxConditionOptions" [value]="cond.value">{{ cond.label }}</option>
        </select>
      </div>
    </div>
    <div class="align-end">
      <div class="actions">
        <button type="button" (click)="guardarCliente()" [disabled]="guardandoCliente">
          {{ guardandoCliente ? 'Guardando cliente…' : (clienteEditando ? 'Actualizar cliente' : 'Guardar cliente') }}
        </button>
        <button *ngIf="clienteEditando" type="button" class="secondary" (click)="cancelarEdicionCliente()" [disabled]="guardandoCliente">
          Cancelar
        </button>
      </div>
    </div>
    <p *ngIf="mensajeCliente" class="helper-text success">{{ mensajeCliente }}</p>
  </div>

  <div *ngIf="loadingClientes" class="empty-state">Cargando clientes…</div>
  <div *ngIf="!loadingClientes && !clientes.length" class="empty-state">
    Todavía no registraste clientes. Completá el formulario superior para agregarlos.
  </div>
  <div *ngIf="!loadingClientes && clientes.length" class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Email</th>
          <th>CUIT</th>
          <th>Condición fiscal</th>
          <th>Dirección fiscal</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cliente of clientes">
          <td>{{ cliente.name }}</td>
          <td>{{ cliente.email }}</td>
          <td>{{ cliente.tax_id }}</td>
          <td>{{ cliente.tax_condition_display }}</td>
          <td>{{ cliente.fiscal_address }}</td>
          <td class="align-end">
            <button type="button" (click)="editarCliente(cliente)">Editar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Proveedores registrados</h2>
  <p class="helper-text">Guardá los datos de los transportistas o proveedores para vincularlos rápidamente con las cartas de porte.</p>

  <div class="card-inline">
    <h3>Agregar nuevo proveedor</h3>
    <div class="grid two-columns">
      <div>
        <label for="nuevoProveedorNombre">Nombre / Razón social</label>
        <input id="nuevoProveedorNombre" [(ngModel)]="nuevoProveedor.name" name="nuevoProveedorNombre" placeholder="Ej: Transporte SRL" />
      </div>
      <div>
        <label for="nuevoProveedorEmail">Email de contacto</label>
        <input id="nuevoProveedorEmail" type="email" [(ngModel)]="nuevoProveedor.email" name="nuevoProveedorEmail" placeholder="Ej: contacto@proveedor.com" />
      </div>
      <div>
        <label for="nuevoProveedorCuit">CUIT</label>
        <input id="nuevoProveedorCuit" [(ngModel)]="nuevoProveedor.tax_id" name="nuevoProveedorCuit" placeholder="Ej: 30-00000000-0" />
      </div>
      <div>
        <label for="nuevoProveedorDomicilio">Dirección fiscal</label>
        <input id="nuevoProveedorDomicilio" [(ngModel)]="nuevoProveedor.fiscal_address" name="nuevoProveedorDomicilio" placeholder="Ej: Ruta 8 km 201" />
      </div>
    </div>
    <div class="align-end">
      <button type="button" (click)="guardarProveedor()" [disabled]="creandoProveedor">
        {{ creandoProveedor ? 'Guardando proveedor…' : 'Guardar proveedor' }}
      </button>
    </div>
    <p *ngIf="mensajeProveedor" class="helper-text success">{{ mensajeProveedor }}</p>
  </div>

  <div *ngIf="loadingProveedores" class="empty-state">Cargando proveedores…</div>
  <div *ngIf="!loadingProveedores && !proveedores.length" class="empty-state">
    Todavía no registraste proveedores. Completá el formulario superior para agregarlos.
  </div>
  <div *ngIf="!loadingProveedores && proveedores.length" class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Email</th>
          <th>CUIT</th>
          <th>Dirección fiscal</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let proveedor of proveedores">
          <td>{{ proveedor.name }}</td>
          <td>{{ proveedor.email || '—' }}</td>
          <td>{{ proveedor.tax_id || '—' }}</td>
          <td>{{ proveedor.fiscal_address || '—' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Tarifas por producto</h2>
  <p class="helper-text">Configurá los valores sugeridos que luego se aplicarán automáticamente al revisar las cartas de porte.</p>

  <div *ngIf="loadingProductos" class="empty-state">Cargando productos…</div>
  <div *ngIf="!loadingProductos && !productos.length" class="empty-state">
    Aún no se detectaron productos en las cartas de porte consultadas.
  </div>
  <div *ngIf="!loadingProductos && productos.length" class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Código AFIP</th>
          <th>Tarifa base</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let producto of productos">
          <td>{{ producto.name }}</td>
          <td>{{ producto.afip_code || '—' }}</td>
          <td>
            <input type="number" min="0" step="0.01" [(ngModel)]="edicionProductos[producto.id]" name="tarifaProducto{{ producto.id }}" />
          </td>
          <td>
            <button type="button" (click)="actualizarTarifaProducto(producto)" [disabled]="actualizandoProducto[producto.id]">
              {{ actualizandoProducto[producto.id] ? 'Guardando…' : 'Actualizar tarifa' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Datos de envíos (CPE)</h2>
  <div *ngIf="loadingEnvios" class="empty-state">Cargando envíos…</div>
  <div *ngIf="!loadingEnvios && !envios.length" class="empty-state">
    Aún no consultaste cartas de porte. Realizá una búsqueda desde la sección "Consulta CPE".
  </div>
  <div *ngIf="!loadingEnvios && envios.length" class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>CTG</th>
          <th>Dominio</th>
          <th>Estado</th>
          <th>Vigencia</th>
          <th>Sucursal / Orden</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let envio of envios">
          <td><strong>{{ envio.nro_ctg }}</strong></td>
          <td>{{ envio.vehicle_domain || '—' }}</td>
          <td>
            <span class="badge" [ngClass]="envio.estado ? 'info' : 'warning'">{{ envio.estado || 'Sin estado' }}</span>
          </td>
          <td>
            <div class="helper-text">Desde {{ envio.fecha_emision | date:'dd/MM/yyyy HH:mm' }}</div>
            <div class="helper-text">Hasta {{ envio.fecha_vencimiento | date:'dd/MM/yyyy HH:mm' }}</div>
          </td>
          <td>{{ envio.sucursal || '—' }} / {{ envio.nro_orden || '—' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
