<section class="card">
  <h2>Emisión de factura electrónica</h2>
  <p class="helper-text">
    Completá los datos del cliente y los del envío para generar el comprobante con un solo clic.
  </p>
  <div class="card-inline" *ngIf="errors.length">
    <h4>Errores al emitir el comprobante</h4>
    <ul>
      <li *ngFor="let error of errors">{{ error }}</li>
    </ul>
  </div>
  <div class="grid two-columns">
    <div>
      <h3>Datos del cliente</h3>
      <div class="grid">
        <label for="cliente">Cliente registrado</label>
        <select
          id="cliente"
          name="client_id"
          [disabled]="clientsLoading"
          [(ngModel)]="model.client_id"
          (ngModelChange)="seleccionarCliente($event ? +$event : null)"
        >
          <option value="">Seleccioná un cliente…</option>
          <option *ngFor="let client of clients" [value]="client.id">{{ client.name }} — {{ client.email }}</option>
        </select>
        <p class="helper-text" *ngIf="clientsLoading">Cargando clientes…</p>
      </div>
      <p class="helper-text">
        ¿Necesitás registrar un nuevo cliente? Hacelo desde la sección
        <a routerLink="/resumen">Clientes &amp; Envíos</a> y luego volvé a esta pantalla para seleccionarlo.
      </p>
      <div class="grid" *ngIf="selectedClient">
        <div class="tag">
          <span>Cliente seleccionado:</span>
          <strong>{{ selectedClient?.name }}</strong>
        </div>
        <p class="helper-text">Email de contacto: {{ selectedClient?.email }}</p>
        <div class="grid two-columns">
          <div>
            <label>Nombre y apellido / Razón social</label>
            <input [value]="selectedClient?.name" readonly />
          </div>
          <div>
            <label>Dirección fiscal</label>
            <input [value]="selectedClient?.fiscal_address" readonly />
          </div>
        </div>
        <p class="helper-text">Condición fiscal: {{ selectedClient?.tax_condition_display }}</p>
      </div>
      <div class="grid two-columns">
        <div>
          <label for="docTipo">Tipo de documento</label>
          <select id="docTipo" [(ngModel)]="model.doc_tipo" name="doc_tipo">
            <option [value]="80">CUIT</option>
            <option [value]="86">CUIL</option>
            <option [value]="96">DNI</option>
          </select>
        </div>
        <div>
          <label for="docNro">Número</label>
          <input id="docNro" [(ngModel)]="model.doc_nro" name="doc_nro" placeholder="Ingresá el número de documento" />
        </div>
      </div>
      <div>
        <label for="iva">Condición frente al IVA</label>
        <select id="iva" [(ngModel)]="model.condicion_iva_receptor_id" name="condicion_iva_receptor_id">
          <option *ngFor="let cond of taxConditionOptions" [value]="cond.value">{{ cond.label }}</option>
        </select>
      </div>
    </div>

    <div>
      <h3>Datos del envío</h3>
      <div class="grid">
        <label for="importe">Importe total</label>
        <input id="importe" type="number" min="0" step="0.01" [(ngModel)]="model.amount" name="amount" placeholder="Ej: 45000.50" />
      </div>
      <div class="grid two-columns">
        <div>
          <label for="ptoVta">Punto de venta</label>
          <input id="ptoVta" type="number" min="0" [(ngModel)]="model.pto_vta" name="pto_vta" />
        </div>
        <div>
          <label for="tipoComprobante">Tipo de comprobante</label>
          <select
            id="tipoComprobante"
            [ngModel]="tipoSeleccionado"
            (ngModelChange)="seleccionarTipo($event)"
            name="tipoSeleccionado"
          >
            <option *ngFor="let tipo of tiposComprobante" [value]="tipo.value">{{ tipo.label }}</option>
          </select>
        </div>
      </div>
      <div class="grid two-columns">
        <div>
          <label for="letraComprobante">Letra</label>
          <select
            id="letraComprobante"
            [ngModel]="letraSeleccionada"
            (ngModelChange)="seleccionarLetra($event)"
            name="letraSeleccionada"
          >
            <option *ngFor="let letra of letrasDisponibles" [value]="letra">{{ letra }}</option>
          </select>
        </div>
        <div *ngIf="tipoSeleccionado !== 'FACTURA'">
          <label>Asociación requerida</label>
          <div class="grid no-gap">
            <label>
              <input
                type="radio"
                name="modoAsociacion"
                value="cbte"
                [checked]="modoAsociacion === 'cbte'"
                (change)="seleccionarModoAsociacion('cbte')"
              />
              Comprobante emitido
            </label>
            <label>
              <input
                type="radio"
                name="modoAsociacion"
                value="periodo"
                [checked]="modoAsociacion === 'periodo'"
                (change)="seleccionarModoAsociacion('periodo')"
              />
              Período asociado
            </label>
          </div>
          <p class="helper-text">
            Elegí si la nota se relaciona con un comprobante puntual o con un período determinado.
          </p>
        </div>
      </div>
      <div
        class="card-inline"
        *ngIf="tipoSeleccionado !== 'FACTURA' && modoAsociacion === 'cbte'"
      >
        <h4>Comprobante asociado</h4>
        <div class="grid two-columns">
          <div>
            <label for="cbteAsocTipo">Tipo de comprobante</label>
            <input
              id="cbteAsocTipo"
              type="number"
              min="1"
              [(ngModel)]="comprobanteAsociado.tipo"
              name="cbteAsocTipo"
            />
          </div>
          <div>
            <label for="cbteAsocPto">Punto de venta</label>
            <input
              id="cbteAsocPto"
              type="number"
              min="0"
              [(ngModel)]="comprobanteAsociado.pto_vta"
              name="cbteAsocPto"
            />
          </div>
          <div>
            <label for="cbteAsocNro">Número de comprobante</label>
            <input
              id="cbteAsocNro"
              type="number"
              min="0"
              [(ngModel)]="comprobanteAsociado.nro"
              name="cbteAsocNro"
            />
          </div>
          <div>
            <label for="cbteAsocCuit">CUIT/CUIL del emisor</label>
            <input
              id="cbteAsocCuit"
              type="text"
              [(ngModel)]="comprobanteAsociado.cuit"
              name="cbteAsocCuit"
              placeholder="Opcional"
            />
          </div>
          <div>
            <label for="cbteAsocFch">Fecha del comprobante</label>
            <input
              id="cbteAsocFch"
              type="date"
              [(ngModel)]="comprobanteAsociado.cbte_fch"
              name="cbteAsocFch"
            />
          </div>
        </div>
        <p class="helper-text">
          Ingresá los datos del comprobante original para asociarlo a la nota.
        </p>
      </div>
      <div
        class="card-inline"
        *ngIf="tipoSeleccionado !== 'FACTURA' && modoAsociacion === 'periodo'"
      >
        <h4>Período asociado</h4>
        <div class="grid two-columns">
          <div>
            <label for="periodoDesde">Desde</label>
            <input
              id="periodoDesde"
              type="date"
              [(ngModel)]="periodoAsociado.desde"
              name="periodoDesde"
            />
          </div>
          <div>
            <label for="periodoHasta">Hasta</label>
            <input
              id="periodoHasta"
              type="date"
              [(ngModel)]="periodoAsociado.hasta"
              name="periodoHasta"
            />
          </div>
        </div>
        <p class="helper-text">
          Especificá el rango de fechas que la nota cubre para el período asociado.
        </p>
      </div>
      <div class="grid">
        <label>Resumen</label>
        <div class="status">
          <span class="status-dot success"></span>
          <div>
            <div><strong>Monto:</strong> {{ model.amount | currency:'ARS':'symbol':'1.2-2' }}</div>
            <div>
              <strong>Pto. Vta:</strong> {{ model.pto_vta }} —
              <strong>Tipo:</strong> {{ descripcionComprobante }} ({{ model.cbte_tipo }})
            </div>
          </div>
        </div>
      </div>
      <button type="button" (click)="emitir()" [disabled]="loading">
        {{ loading ? 'Emitiendo comprobante…' : 'Emitir factura' }}
      </button>
    </div>
  </div>
</section>

<section class="card" *ngIf="resp">
  <h3>Factura emitida correctamente</h3>
  <div class="grid two-columns">
    <div>
      <label>Comprobante</label>
      <div class="tag">
        {{ resp.cbte_tipo }}-{{ resp.pto_vta }}-{{ resp.cbte_nro || 's/n' }}
      </div>
    </div>
    <div>
      <label>CAE</label>
      <div class="badge success">{{ resp.cae }}</div>
    </div>
    <div>
      <label>Importe</label>
      <div>{{ resp.amount | currency:'ARS':'symbol':'1.2-2' }}</div>
    </div>
    <div>
      <label>Cliente</label>
      <div>{{ resp.client_name }} ({{ resp.client_email }})</div>
    </div>
  </div>
  <p class="helper-text">Podés descargar el PDF desde la sección de comprobantes cuando se genere.</p>
</section>
